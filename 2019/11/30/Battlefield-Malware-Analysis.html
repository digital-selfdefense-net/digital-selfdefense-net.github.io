<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Hackerspace, Infosec Community, IT Security, Cyber Security, Information Security, Ethical Hacking, Penetration Testing, Web Application Security, Network Security, Cryptography, Security Research, Malware Analysis, Threat Intelligence, OSINT, OPSEC, Reverse Engineering, Exploit Development, DFIR, Forensics, Incident Response, SOC, CSIRT">
    <meta name="author" content="anonymous">
    <title>Digital Self-Defense Lab - Battlefield Malware Analysis (Part 1)</title>
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet">
    <link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="/assets/css/main.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
    <link rel="icon" type="image/png" href="/assets/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/assets/img/favicon-96x96.png" sizes="96x96">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
  </head>
  <body id="page-top">
    <div class="container-fluid p-0">
      <section class="main-section p-3 p-lg-5 d-flex align-items-center" id="blog">
        <div class="w-100">
          <article class="lead">
            <header class="mb-4">
              <h2>Battlefield Malware Analysis (Part 1)</h2>
              <time datetime="2019-11-30T11:00:02+01:00" class="text-primary">Posted on 30 Nov 2019 by anonymous</time>
            </header>
            <div class="message">
              Hello Folks! In this blog post series named "Battlefield Malware Analysis" we will be investigating different tools and techniques 
              that you as a Malware Analysts / SOC Analyst / Incident Responder / (you name it) can use to make your life easier when dealing 
              with Malware Analysis. The "Battlefield" aspect of this blog post series stems from the fact that we will be covering real life malware analysis 
              problems which we encounter on a daily basis, and show you simple yet effective ways to cope with them. This blog post series aims to be 
              as practical as possible, by this we mean that we won't solely focus on the theoretical aspects of malware analysis but rather get our hands 
              dirty by dissecting malware.
            </div>
            <p>Enough talk. Now it’s time to fasten our seatbelts and dig through some malware!</p>
            <h2 id="introduction">Introduction</h2>
            <p>In the first part of “Battlefield Malware Analysis” we will take a look at script based obfuscation and how it can be defeated in a fast and efficient way by using process injection and API hooking. Before we jump straight into the practical part let us define what we mean by script based obfuscation and why it is still so prevalent these days.</p>
            <p>Script based obfuscation is a technique used by malware authors that allows them to hide the malicious intent of their scripts from malware analysts and anti-virus. This is achieved by abusing scripting language features like eval functions<sup id="fnref:fn-eval_function"><a href="#fn:fn-eval_function" class="footnote">1</a></sup>, anonymous functions<sup id="fnref:fn-anonymous_function"><a href="#fn:fn-anonymous_function" class="footnote">2</a></sup> and string based encryption, encoding or transformation.</p>
            <p>When we think of recent malware campaigns we often see that the initial attack vector used by todays attackers is still phishing. With the help of legitimate looking phishing e-mails attackers are able to get a first foothold into their target organization.</p>
            <p>Back in the golden days of malware (80’s and 90’s) it was very common to see malicious attachments like for example “file.pdf.exe” as part of phishing e-mails. Nowadays people are aware of the fact there is baerly no valid reason to deliver exectuable files via e-mail attachments, and therefore we often see them being blocked by default.</p>
            <p>Malware authors adapted to these restrictions by abusing legitimate file formats which are commonly used as e-mail attachments and provide some sort of scripting capabilities which will allow them to download and execute malicious code on their victims host.</p>
            <p>The prevalence of script based obfuscation techniques during the delivery stage of the Cyber Kill-Chain<sup id="fnref:fn-cyber_kill_chain"><a href="#fn:fn-cyber_kill_chain" class="footnote">3</a></sup> is closely related to the fact that executable files are no longer a reliable way for initial infection.</p>
            <h2 id="scenario">Scenario</h2>
            <p>Now it’s time to introduce the scenario that we will be dealing within the first part of our blog post series:</p>
            <figure class="highlight">
              <pre><code class="language-text" data-lang="text">You are a malware analyst tasked to analyze a bunch of malicious JScript attachments that were 
delivered as part of phishing campaign to a group of c-level executives from your company. 

Some of the c(lick) level executives from your company already opened the attachments and now you are
in a hurry because they expect quick answers to clarify what happend.

It's time to boot up your analyst workstation and provide the information your they requested from you. </code></pre>
            </figure>
            <p><a href="/assets/uploads/2019/11/post3/files/obfuscated.js">Here</a> you can download the malicious JScript attachment.</p>
            <h2 id="lab-setup">Lab Setup</h2>
            <p>In order to complete the exercise and become the hero of your company we recommend the following tools:</p>
            <ol>
              <li>Windows Server 2012 R2 64-Bit</li>
              <li>Python 3.7.5</li>
              <li>Frida 12.7.20</li>
              <li>wscript.exe</li>
              <li>(x64dbg [Apr 29 2019])</li>
            </ol>
            <p>Other OS/Software versions will probably work too.</p>
            <h2 id="which-apis-to-look-for">Which APIs to look for?</h2>
            <p>When dealing with malicious scripts like VBScript or JScript you will notice that the vast majority of malicious scripts depend on activex controls<sup id="fnref:fn-activex_control"><a href="#fn:fn-activex_control" class="footnote">4</a></sup> / COM Objects<sup id="fnref:fn-COM_object"><a href="#fn:fn-COM_object" class="footnote">5</a></sup> to overcome the limitations imposed by the scripting language interpreter. By using activex controls from within JScript for example it is possible to accomplish certain tasks such as writing to the registry, creating files or executing other applications, which would be otherwise not possible without direct access to the Windows API. Malware authors will very likely try to hide those kind of actions by using obfuscation techniques for the purpose of avoiding detection from human analysts and anti-virus. The following JScript named “example.js” is intended as a toy example to demonstrate how activex controls can be used to start another application:</p>
            <figure class="highlight">
              <pre><code class="language-js" data-lang="js"> 
<span class="c1">// example.js</span>

<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">language</span><span class="o">=</span><span class="dl">"</span><span class="s2">JScript</span><span class="dl">"</span><span class="o">&gt;</span>
    <span class="kd">function</span> <span class="nx">fnShellExecuteJ</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">objShell</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">shell.application</span><span class="dl">"</span><span class="p">);</span>
        
        <span class="nx">objShell</span><span class="p">.</span><span class="nx">ShellExecute</span><span class="p">(</span><span class="dl">"</span><span class="s2">notepad.exe</span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">,</span> <span class="dl">""</span><span class="p">,</span> <span class="dl">"</span><span class="s2">open</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script&gt;</span></code></pre>
            </figure>
            <p>In Microsoft Windows, JScript files are associated with the Windows Script Host<sup id="fnref:fn-windows_script_host"><a href="#fn:fn-windows_script_host" class="footnote">6</a></sup> (wscript.exe). This means that when a user double clicks a JScript file it will immediately be executed by wscript.exe. These circumstances are the reason why obfuscated JScript files are so popular among attackers. They provide a simple and effecitve way of executing malicious code on a target system. In the case of “example.js” a double click would result in the execution of the Windows API function <code class="highlighter-rouge">ShellExecuteExW</code> from <code class="highlighter-rouge">Shell32.dll</code>, which in turn will create the process “notepad.exe”.</p>
            <p>But how does wscript.exe know that <code class="highlighter-rouge">ShellExecuteExW</code><sup id="fnref:fn-msdn_ShellExecuteExW"><a href="#fn:fn-msdn_ShellExecuteExW" class="footnote">7</a></sup> is implemented in <code class="highlighter-rouge">Shell32.dll</code>? This information can be obtained from the windows registry in two simple steps:</p>
            <ol>
              <li>wscript.exe needs to lookup <code class="highlighter-rouge">HKEY_CLASSES_ROOT\Shell.Application\CLSID</code>.</li>
              <li>The <code class="highlighter-rouge">CLSID = {?}</code> value is used by wscript.exe to lookup the <code class="highlighter-rouge">InProcServer32</code> under <code class="highlighter-rouge">HKEY_CLASSES_ROOT\CLSID\{?}</code>, which holds the implementation of <code class="highlighter-rouge">ShellExecuteExW</code>.</li>
            </ol>
            <p>Now it’s time to take a look at the malicious JScript attachments that were send to the c-level execs of our company. The first thing we notice when we search for common keywords like <code class="highlighter-rouge">ShellExecute</code> is that we found one match. But unlike in “example.js” the parameters passed to <code class="highlighter-rouge">ShellExecute</code> are obfuscated, as presented in figure 1.</p>
            <p><img src="/assets/uploads/2019/11/post3/images/1.PNG" alt="Figure 1: obfuscated.js" title="obfuscated.js" /></p>
            <p>In the next step we need to get rid of the obfuscation without wasting to much precious time and brain resources on deobfuscating stuff in our head. By debugging wscript.exe and passing “obfuscated.js” as an argument it is possible to verify that the Windows API function <code class="highlighter-rouge">ShellExecuteExW</code> indeed is executed. This can be seen in the Debbuger Window (x64dbg) depicted in figure 2:</p>
            <p><img src="/assets/uploads/2019/11/post3/images/2.PNG" alt="Figure 2: Shell32.ShellExecuteExW" title="Shell32.ShellExecuteExW" /></p>
            <p>The first argument (<code class="highlighter-rouge">EBP+8</code>) passed to <code class="highlighter-rouge">ShellExecuteExW</code> is pointer to the struct <code class="highlighter-rouge">SHELLEXECUTEINFOW</code><sup id="fnref:fn-msdn_SHELLEXECUTEINFOW"><a href="#fn:fn-msdn_SHELLEXECUTEINFOW" class="footnote">8</a></sup>, which contains information such as the application that needs to be exeucted, it’s commandline arguments and other settings. From an Malware Analysts standpoint the contents of the struct are very valuable because they have to be in deobfuscated form, so that <code class="highlighter-rouge">ShellExecuteExW</code> is able to execute the intended application. This means that the deobfuscation routine needs to be applied before the arguments are passed to <code class="highlighter-rouge">ShellExecuteExW</code>. By setting a breakpoint at <code class="highlighter-rouge">ShellExecuteExW</code> we can capture the deobfuscated arguments passed as a pointer to the struct <code class="highlighter-rouge">SHELLEXECUTEINFOW</code>.</p>
            <p>In the following step we will take a look at the memory address <code class="highlighter-rouge">004AD94C</code> in the dump section of our debbuger. This is the address where the struct <code class="highlighter-rouge">SHELLEXECUTEINFOW</code> resides in memory:</p>
            <p><img src="/assets/uploads/2019/11/post3/images/3.PNG" alt="Figure 3: SHELLEXECUTEINFOW" title="SHELLEXECUTEINFOW" /></p>
            <p>The struct contains several fields that are of interest for further analysis. To get a complete understanding of the struct <code class="highlighter-rouge">SHELLEXECUTEINFOW</code> we recommend to lookup the definition on msdn (<a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/ns-shellapi-shellexecuteinfow">here</a>). In figure 3 we can already see some of the fields like for example <code class="highlighter-rouge">lpVerb</code>, <code class="highlighter-rouge">lpFile</code>, <code class="highlighter-rouge">lpParameters</code>, <code class="highlighter-rouge">lpDirectory</code> and <code class="highlighter-rouge">nShow</code>.</p>
            <p>If our goal is to understand which application gets executed by <code class="highlighter-rouge">ShellExecuteExW</code> and what arguments are passed to it during execution, we need to take a look at the fields <code class="highlighter-rouge">lpFile</code> and <code class="highlighter-rouge">lpParameters</code>. When we inspect these fields we will see that “obfuscated.js” executes the following command:</p>
            <figure class="highlight">
              <pre><code class="language-text" data-lang="text">powershell.exe -exec bypass -command "whoami ; sleep 5"</code></pre>
            </figure>
            <p><em>Success</em>! Now we are able to give our boss the information he needs to calm down the c-level execs of our company. But wait! There are still some malicious JScript files left for analysis. The question now is how you can analyze them without redoing all the steps presented so far? The answer to this question will be covered in the next section. Another important question that needs to be answered is what Windows APIs to look for when dealing with obfuscated scripts? The answer is simple! We don’t know what APIs to look for beforehand because each malicious script is different. The best way to undestand what the malware does and to defeat obfuscation is to intercept all interesting APIs. You might ask yourself what APIs are interesting then? Well it depends, but the blog post “<a href="https://blog.talosintelligence.com/2017/08/windbg-and-javascript-analysis.html">WinDBG and JavaScript Analysis</a>” from Cisco Talos is a good starting point.</p>
            <h2 id="analyzing-malicious-scripts-at-scale">Analyzing malicious scripts at scale</h2>
            <p>In this section of the blog post we will explaint to you how we can analyze a bunch of malicious JScript attachments without repeating the tedious steps introduced in the last section. The answer to this is simple! With the help of process injection and API Hooking, we are able to analyze the function calls of our interest. This allows us to bypass obfuscation and get an understanding of what the malicious script tries to achive on the victims machine. But what if we are really lazy people and we don’t want to implement all of this process injection<sup id="fnref:fn-process_injection"><a href="#fn:fn-process_injection" class="footnote">9</a></sup> and hooking<sup id="fnref:fn-hooking"><a href="#fn:fn-hooking" class="footnote">10</a></sup> stuff on our own? Then <a href="https://frida.re/">Frida</a> is our answer!</p>
            <p>But what is Frida? According to the projects webpage Frida is <cite>“[…] Greasemonkey for native apps, or, put in more technical terms, it’s a dynamic code instrumentation toolkit. It lets you inject snippets of JavaScript or your own library into native apps on Windows, macOS, GNU/Linux, iOS, Android, and QNX. Frida also provides you with some simple tools built on top of the Frida API. These can be used as-is, tweaked to your needs, or serve as examples of how to use the API.”</cite>.</p>
            <p>As you might guess from the description above there are plenty of things that you can do with Frida, but in our case we will solely focuse on how it can be used to automate the deobfuscation of “obfuscated.js”. Wait! so you are telling me…</p>
            <p><img src="/assets/uploads/2019/11/post3/images/4.jpg" alt="Figure 4: Mandatory Meme" title="Mandatory Meme" /></p>
            <p>Indeed, we will use Frida’s core, Gum (Instrumentation Library) and Gum’s JavaScript binding GumJS to hook <code class="highlighter-rouge">ShellExecuteExW</code> and grab the passed arguments in a deobfuscated state. In theory this is achieved as follows:</p>
            <ol>
              <li>Frida core suspends the target process wscript.exe.</li>
              <li>Frida core creates a remote thread in the target process which then loads Frida agent (Gum + Google’s V8 Engine) distributed as a shared library.</li>
              <li>Gum is used to hook the function <code class="highlighter-rouge">ShellExecuteExW</code> from Shell32.dll in the target process wscript.exe.</li>
              <li>Everytime <code class="highlighter-rouge">ShellExecuteExW</code> is called in inside the target process our JavaScript gets executed with the help of Google’s V8 Engine, which then gives us full access to the arguments passed to <code class="highlighter-rouge">ShellExecuteExW</code>.</li>
            </ol>
            <p>Before we start writing the JavaScript Code that will be executed instead of <code class="highlighter-rouge">ShellExecuteExW</code>, we can use <code class="highlighter-rouge">frida-trace</code> to create a template for us. Please be aware of the fact that when we run <code class="highlighter-rouge">frida-trace</code> as presented in figure 5 the obfuscated JScript will be executed. When analyzing an unknown script this step is not recommended.</p>
            <p><img src="/assets/uploads/2019/11/post3/images/5.PNG" alt="Figure 5: frida-trace" title="frida-trace" /></p>
            <p>After running <code class="highlighter-rouge">frida-trace</code> the directory “__handlers__\SHELL32.dll\” is created in the current path. This directory contains the JavaScript file “ShellExecuteExW.js” which represents the template mentioned earlier. The JavaScript “ShellExecuteExW.js” will be used to define the behaviour of the hooked function <code class="highlighter-rouge">ShellExecuteExW</code>. Everytime the function <code class="highlighter-rouge">ShellExecuteExW</code> is called within wscript.exe the hooking function <code class="highlighter-rouge">onEnter</code> will also be executed.</p>
            <figure class="highlight">
              <pre><code class="language-js" data-lang="js"> 
<span class="cm">/**
* Called synchronously when about to call ShellExecuteExW.
*

onEnter: function (log, args, state) {
	//Place your hook functionality here.
},</span></code></pre>
            </figure>
            <p>The arguments passed to <code class="highlighter-rouge">ShellExecuteExW</code>, will also be present in our hooking function <code class="highlighter-rouge">onEnter</code>, via the array <code class="highlighter-rouge">args</code>. Recall from the previous section that the first and only argument passed to <code class="highlighter-rouge">ShellExecuteExW</code> is a pointer to the struct <code class="highlighter-rouge">SHELLEXECUTEINFOW</code>. The address of the struct can now be used to access all the interesting fields which will reveal the purpose of the malicious JScript “obfuscated.js”. Figure 6 depicts the final implementation of the hooking function.</p>
            <p><img src="/assets/uploads/2019/11/post3/images/6.PNG" alt="Figure 6: Hooking function onEnter" title="Hooking function onEnter" /></p>
            <p>Finally, if we rerun <code class="highlighter-rouge">frida-trace</code> with the same commandline arguments as in figure 5, the previously defined hooking function will be executed whenever <code class="highlighter-rouge">ShellExecuteExW</code> is called within wscript.exe. The hooking function will then print out all of the interesting fields from the struct <code class="highlighter-rouge">SHELLEXECUTEINFOW</code> passed to <code class="highlighter-rouge">ShellExecuteExW</code>:</p>
            <p><img src="/assets/uploads/2019/11/post3/images/7.PNG" alt="Figure 7: Final frida-trace " title="Final frida-trace" /></p>
            <p>With the help of <code class="highlighter-rouge">frida-trace</code> and the hooking function <code class="highlighter-rouge">onEnter</code> from “ShellExecuteExW.js”, we can now automate the analysis of the malicious JScript attachments that were received by the c-level executives of our company.</p>
            <h2 id="final-thoughts">Final Thoughts</h2>
            <p>The approach presented in this blog post is based on the hypothesis that malware authors at some point will need to extend the functionality of their malicious scripts by using activex controls / COM Objects in order to get access to more powerful APIs. When doing so, it is highly likely that malware authors will try to hide the specifics (function names, arguments) of the APIs used by employing some form of obfuscation. With the help of frida we can easily intercept all the relevant API calls used by malicious scripts which allows us to bypass the implemented obfuscation techniques. Another great benefit that comes from using frida is the high grade of automation that can be achieved by using it.</p>
            <hr />
            <p>Want to see something else added? <a href="https://github.com/digital-selfdefense-net/digital-selfdefense-net.github.io/issues/new">Open an issue.</a></p>
            <div class="footnotes">
              <ol>
                <li id="fn:fn-eval_function">
                  <p><a href="https://en.wikipedia.org/wiki/Eval">Eval Functions</a> <a href="#fnref:fn-eval_function" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-anonymous_function">
                  <p><a href="https://en.wikipedia.org/wiki/Anonymous_function">Anonymous Function</a> <a href="#fnref:fn-anonymous_function" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-cyber_kill_chain">
                  <p><a href="https://en.wikipedia.org/wiki/Kill_chain#The_Cyber_Kill_Chain">Cyber Kill Chain</a> <a href="#fnref:fn-cyber_kill_chain" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-activex_control">
                  <p><a href="https://en.wikipedia.org/wiki/ActiveX">ActiveX Control</a> <a href="#fnref:fn-activex_control" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-COM_object">
                  <p><a href="https://en.wikipedia.org/wiki/Component_Object_Model">COM Object</a> <a href="#fnref:fn-COM_object" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-windows_script_host">
                  <p><a href="https://en.wikipedia.org/wiki/Windows_Script_Host">Windows Script Host</a> <a href="#fnref:fn-windows_script_host" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-msdn_ShellExecuteExW">
                  <p><a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecuteexw">ShellExecuteExW</a> <a href="#fnref:fn-msdn_ShellExecuteExW" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-msdn_SHELLEXECUTEINFOW">
                  <p><a href="https://docs.microsoft.com/de-de/windows/win32/api/shellapi/ns-shellapi-shellexecuteinfow">SHELLEXECUTEINFOW</a> <a href="#fnref:fn-msdn_SHELLEXECUTEINFOW" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-process_injection">
                  <p><a href="https://en.wikipedia.org/wiki/DLL_injection">DLL Injection</a> <a href="#fnref:fn-process_injection" class="reversefootnote">&#8617;</a></p>
                </li>
                <li id="fn:fn-hooking">
                  <p><a href="https://en.wikipedia.org/wiki/Hooking">Hooking</a> <a href="#fnref:fn-hooking" class="reversefootnote">&#8617;</a></p>
                </li>
              </ol>
            </div>
            <footer>
              <aside class="mt-5">
                <h3>Related posts</h3>
                <ul>
                  <li>
                    <a href="/2020/04/11/Understanding-CVE-2020-0688.html">
                      Understanding CVE-2020-0688
                      <small><time class="text-primary" datetime="2020-04-11T12:00:00+02:00">11 Apr 2020</time></small>
                    </a>
                  </li>
                  <li>
                    <a href="/2020/01/19/WMI-Persistence.html">
                      WMI Persistence (T1084)
                      <small><time class="text-primary" datetime="2020-01-19T11:00:00+01:00">19 Jan 2020</time></small>
                    </a>
                  </li>
                  <li>
                    <a href="/2019/11/30/Do-It-Yourself-Privacy-Phone.html">
                      Do it yourself Privacy Phone
                      <small><time class="text-primary" datetime="2019-11-30T11:00:01+01:00">30 Nov 2019</time></small>
                    </a>
                  </li>
                </ul>
              </aside>
              <hr class="m-2">
              <div class="pagination-wrapper">
                <div class="pagination">
                  <a class="pagination-step" href="/">Back home</a>
                  <a class="pagination-step" href="/blog/">More posts</a>
                </div>
              </div>
            </footer>
          </article>
        </div>
      </section>
    </div>
    <div class="container-fluid p-0">
      <footer class="global-footer">
        <p class="m-0 text-center text-white">Copyright &copy; 2020, Digital Self-Defense Lab</p>
      </footer>
    </div>
    <script src="/assets/vendor/jquery/jquery.min.js"></script>
    <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="/assets/js/main.min.js"></script>
  </body>
</html>